let
    // Robust helpers to fetch numeric parameters from GlobalNumericParameters or GlobalTextParameters
    TryGetWideValue = (tbl as table, names as list) as any =>
        let
            tryRow = try tbl{0} otherwise null,
            value = if tryRow = null then null else List.First(List.RemoveNulls(List.Transform(names, (n) => try Record.Field(tryRow, n) otherwise null)), null)
        in
            value,
    TryGetKVValue = (tbl as table, keyNames as list, valNames as list, paramNames as list) as any =>
        let
            cols = try Table.ColumnNames(tbl) otherwise {},
            keyCol = List.First(List.RemoveNulls(List.Transform(keyNames, (n) => if List.Contains(cols, n) then n else null)), null),
            valCol = List.First(List.RemoveNulls(List.Transform(valNames, (n) => if List.Contains(cols, n) then n else null)), null),
            found = if keyCol <> null and valCol <> null then
                let
                    lowered = Table.TransformColumns(tbl, {{keyCol, each Text.Lower(Text.From(_)), type text}}),
                    target = List.Transform(paramNames, each Text.Lower(_)),
                    row = try Table.SelectRows(lowered, each List.Contains(target, Record.Field(_, keyCol))){0} otherwise null
                in row else null,
            value = try (if found <> null then Record.Field(found, valCol) else null) otherwise null
        in
            value,
    GetNumericParameter = (paramName as text, optional altNames as nullable list) as number =>
        let
            names = if altNames = null then {paramName} else List.Distinct({paramName} & altNames),
            wideNum = try TryGetWideValue(GlobalNumericParameters, names) otherwise null,
            kvNum = try TryGetKVValue(GlobalNumericParameters, {"ParameterName", "Parameter", "Name", "Key"}, {"Value", "NumericValue", "NumberValue"}, names) otherwise null,
            wideText = try TryGetWideValue(GlobalTextParameters, names) otherwise null,
            kvText = try TryGetKVValue(GlobalTextParameters, {"ParameterName", "Parameter", "Name", "Key"}, {"Value", "TextValue"}, names) otherwise null,
            candidate = List.First(List.RemoveNulls({wideNum, kvNum, wideText, kvText}), null),
            result = try Number.From(candidate) otherwise 0
        in
            result,
    // Compute monthly average balances from balances (independent of PartnerFIView)
    BalBase = Table.SelectColumns(BalancesTable, {"Month", "ScenarioName", "ScenarioDisplay", "CheckingBalance", "SavingsBalance"}),
    GroupedAverages = Table.Group(BalBase, {"ScenarioName", "ScenarioDisplay"}, {{"Rows", each
        let
            Sorted = Table.Sort(_, {{"Month", Order.Ascending}}),
            C_Bal = Table.Column(Sorted, "CheckingBalance"),
            C_Prev = {0} & List.RemoveLastN(C_Bal, 1),
            AvgChecking = List.Transform(List.Zip({C_Prev, C_Bal}), each (_{0} + _{1}) / 2),
            S_Bal = Table.Column(Sorted, "SavingsBalance"),
            S_Prev = {0} & List.RemoveLastN(S_Bal, 1),
            AvgSavings = List.Transform(List.Zip({S_Prev, S_Bal}), each (_{0} + _{1}) / 2),
            Result = Table.FromColumns(
                Table.ToColumns(Sorted) & {AvgChecking, AvgSavings},
                Table.ColumnNames(Sorted) & {"AvgCheckingBalance", "AvgSavingsBalance"}
            )
        in
            Result, type table}}),
    WithAverages = Table.Combine(GroupedAverages[Rows]),

    // Add total deposits and debit card transaction amount from inflows/outflows
    JoinedInflows = Table.NestedJoin(WithAverages, {"Month", "ScenarioName"},
        Table.SelectColumns(InflowsTable, {"Month", "ScenarioName", "Total_Inflows"}), {"Month", "ScenarioName"},
        "InflowsData", JoinKind.LeftOuter),
    ExpandedInflows = Table.ExpandTableColumn(JoinedInflows, "InflowsData", {"Total_Inflows"}, {"Total_Inflows"}),

    JoinedOutflows = Table.NestedJoin(ExpandedInflows, {"Month", "ScenarioName"},
        Table.SelectColumns(OutflowsTable, {"Month", "ScenarioName", "DebitCardTransactionAmount"}), {"Month", "ScenarioName"},
        "OutflowsData", JoinKind.LeftOuter),
    ExpandedOutflows = Table.ExpandTableColumn(JoinedOutflows, "OutflowsData", {"DebitCardTransactionAmount"}, {"DebitCardTransactionAmount"}),

    // Partner rates from GlobalNumericParameters with safe defaults
    PartnerInterchangeRateValue = GetNumericParameter("PartnerInterchangeRate", {"Partner Interchange Rate", "InterchangeRate", "Interchange Rate"}),
    PartnerInterestRateValue = GetNumericParameter("PartnerInterestRate", {"Partner Interest Rate", "InterestRate", "Interest Rate"}),
    FilledInterest = Table.AddColumn(
        Table.AddColumn(ExpandedOutflows, "PartnerInterchangeRate", each PartnerInterchangeRateValue),
        "PartnerInterestRate", each PartnerInterestRateValue
    ),

    // Compute monthly revenue components
    AddedInterchangeRevenue = Table.AddColumn(FilledInterest, "InterchangeRevenue", each [DebitCardTransactionAmount] * [PartnerInterchangeRate]),
    AddedCheckingInterestRevenue = Table.AddColumn(AddedInterchangeRevenue, "CheckingInterestRevenue", each [AvgCheckingBalance] * [PartnerInterestRate]),
    AddedSavingsInterestRevenue = Table.AddColumn(AddedCheckingInterestRevenue, "SavingsInterestRevenue", each [AvgSavingsBalance] * [PartnerInterestRate]),

    // Derive Year from Month
    AddedYear = Table.AddColumn(AddedSavingsInterestRevenue, "Year", each Number.IntegerDivide([Month] - 1, 12) + 1, Int64.Type),

    // Aggregate yearly metrics per scenario
    GroupedYear = Table.Group(AddedYear, {"ScenarioName", "ScenarioDisplay", "Year"}, {
        {"TotalDeposits", each List.Sum([Total_Inflows]), type number},
        {"TotalDebitCardTransactionAmount", each List.Sum([DebitCardTransactionAmount]), type number},
        {"TotalCheckingBalanceForInterest", each List.Sum([AvgCheckingBalance]), type number},
        {"TotalSavingsBalanceForInterest", each List.Sum([AvgSavingsBalance]), type number},
        {"AveragePartnerInterchangeRate", each List.Average([PartnerInterchangeRate]), type number},
        {"AveragePartnerInterestRate", each List.Average([PartnerInterestRate]), type number},
        {"InterchangeRevenueEstimate", each List.Sum([InterchangeRevenue]), type number},
        {"InterestRevenueEstimate", each List.Sum([CheckingInterestRevenue]) + List.Sum([SavingsInterestRevenue]), type number}
    }),

    AddedTotalBalanceForInterest = Table.AddColumn(GroupedYear, "TotalBalanceForInterest", each [TotalCheckingBalanceForInterest] + [TotalSavingsBalanceForInterest]),

    ChangedTypes = Table.TransformColumnTypes(AddedTotalBalanceForInterest, {
        {"Year", Int64.Type},
        {"TotalDeposits", type number},
        {"TotalDebitCardTransactionAmount", type number},
        {"TotalCheckingBalanceForInterest", type number},
        {"TotalSavingsBalanceForInterest", type number},
        {"TotalBalanceForInterest", type number},
        {"AveragePartnerInterchangeRate", type number},
        {"AveragePartnerInterestRate", type number},
        {"InterchangeRevenueEstimate", type number},
        {"InterestRevenueEstimate", type number}
    })
in
    ChangedTypes

